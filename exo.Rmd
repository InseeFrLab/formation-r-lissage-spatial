---
title: "Formation analyse urbaine - Travaux pratiques sur R (carroyage, lissage, zones à façon) [Exercice]"
author: "Kim Antunez et Julien Pramil"
date: "11 mars 2021"
output:
  unilur::tutorial_html_solution:
    toc: true
    toc_float: false
    toc_depth: 1
    suffix: ""
    theme: journal
    highlight: kate
    number_sections: no
    number_subsections: no
---

```{r knitr_init, echo=FALSE, cache=FALSE, include=FALSE}
if (!require("unilur", character.only = TRUE)) {
      install.packages("unilur", dependencies = TRUE)
      library("unilur", character.only = TRUE)
    }
library(knitr)

## Global options
options(max.print="90")
opts_chunk$set(echo=TRUE,
               cache=FALSE, #TRUE
               prompt=FALSE,
               tidy=FALSE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=90)
options(width = 90)

# no margins
knit_hooks$set(nm = function(before, options, envir){
  if (before){
    par(mar=c(0,0,0,0))
  }
})

# title margins
knit_hooks$set(sm = function(before, options, envir){
  if (before){
    par(mar=c(0,0,1.2,0))
  }
})

# boxes custom
#remotes::install_github("koncina/unilur")
knitr::opts_template$set(alert = list(box.title = "Watch out!",
                                      box.body = list(fill = "#ffe0d9", colour = "black"),
                                      box.header = list(fill = "#FFAD99", colour = "black"),
                                      box.collapse = NULL,
                                      box.icon = "fa-exclamation-triangle"))
knitr::opts_template$set(solution = list(box.title = "Solution",
                                         box.body = list(fill = "#e6f6e7", colour = "black"),
                                         box.header = list(fill = "#ace1af", colour = "black"),
                                         box.icon = "fa-check-square",
                                         box.collapse = TRUE))
knitr::opts_template$set(information = list(box.title = "Information",
                                            box.body = list(fill = "#bbe8f4", colour = "black"),
                                            box.header = list(fill = "#64c9e6", colour = "black"),
                                            box.icon = "fa-info-circle",
                                            box.collapse = NULL))
knitr::opts_template$set(clues = list(box.title = "Indices",
                                      box.body = list(fill = "#fff9dc", colour = "black"),
                                      box.header = list(fill = "#ffec8b", colour = "black"),
                                      box.icon = "fa-search",
                                      box.collapse = TRUE))
```

# Présentation de l'exercice

Utilisation de données concernant les parkings publics dans le centre-ville de Bordeaux : 

- Présentation des données
- Présentation de la zone d'intérêt

Objectif

Comment travailler ? 

- Connexion au SSPCloud
- Ouvrir un service RStudio
- Nouveau Script

# Exercice 0 : installation de la session et importation des données

```{block, box.title = "1", box.body = list(fill = "white"), box.icon = "fa-star"}

Pour cette partie, vous pouvez aller chercher directement la solution ci-dessous (hors programme)

Installation des packages suivants : 

- dplyr
- sf
- btb
- mapsf
- leaflet

Par ailleurs, on installe `aws.s3` pour importer les données stockées sous Minio (solution de stockage de données sous SSPCloud)
```


```{r echo=TRUE, solution=TRUE}
## Liste des librairies utilisées
packages <-  c("dplyr","sf","btb","mapsf","leaflet","aws.s3")

## Vérifier si la librairie est installée, si non l'installer, puis la charger
package.check <- lapply(
  packages,
  FUN = function(x) {
    if (!require(x, character.only = TRUE)) {
      install.packages(x, dependencies = TRUE)
      library(x, character.only = TRUE)
    }
  }
)

```




```{block, box.title = "1", box.body = list(fill = "white"), box.icon = "fa-star"}

Hors formation : il suffit de recopier la solution.
Importation des données stockées sous Minio, dans le "bucket public" : s3/jpramil/diffusion.

- `parkings.RDS` : données sur les parkings publics, avec leurs coordonnées xy
- `bordeaux_centre.gpkg` : découpage à façon du centre-ville de Bordeaux

```

```{r echo=TRUE, solution=TRUE}

# Charger la source de données (variable nommée dfBase)
parkings <- 
  aws.s3::s3read_using(
    FUN = base::readRDS,
    object = "diffusion/parking.RDS",
    bucket = "jpramil"
    ,
    opts = list("region" = "")
  )

centreBdx <- 
  aws.s3::s3read_using(
    FUN = sf::st_read,
    object = "diffusion/bordeaux_centre.gpkg",
    bucket = "jpramil"
    ,
    opts = list("region" = "")
  )
# Visualiser les premières lignes de la base
head(parkings)
head(centreBdx)
```



# Exercice 1 : Prendre connaissance des données

```{block, box.title = "1", box.body = list(fill = "white"), box.icon = "fa-star"}

Répondre aux questions suivantes : 

- Combien de parkings publics concernés dans la base ?
- Vérifier qu'il n'y a pas de données manquantes dans les variables de position géographiques.

```
```{r echo=TRUE, solution=TRUE}
head(parkings)
nrow(parkings) # 87 parkings dans la base

# Absence de valeurs manquantes dans les xy 
sum(is.na(parkings$x))
sum(is.na(parkings$y))

```

```{block, box.title = "1", box.body = list(fill = "white"), box.icon = "fa-star"}

Observer l'emprise du contour du centre-ville de Bordeaux.
Pour cela : 
- Créer une nouvelle base `centreBdx_4326` correspondant à une reprojection de `centreBdx` en coordonnées WGS84 (à l'aide de la fonction `sf::st_transform`) ;
- Cartographier `centreBdx_4326` à l'aide de la fonction `leaflet::leaflet` (avec un fond de carte OpenStreetMap).
```

```{r echo=TRUE, solution=TRUE}
# Reprojection
centreBdx_4326 <- centreBdx %>% st_transform(4326)

# Cartographie avec leaflet
leaflet(data=centreBdx_4326) %>% addTiles() %>% addPolygons()

```

# Exercice 2 : Carroyer 















# Exercice type 

```{block, box.title = "1", box.body = list(fill = "white"), box.icon = "fa-star"}

```

```{block, opts.label = "clues"}
Indices
```

```{block, solution = TRUE}
Solution sans code
```

```{r echo=TRUE, solution=TRUE}

```


```{block, box.title = "2", box.body = list(fill = "white"), box.icon = "fa-star"}
 TODO
```

```{block, box.title = "3", box.body = list(fill = "white"), box.icon = "fa-star"}
 TODO
```


--------------------------------------------

--------------------------------------------

**Reproducibilité**

```{r}
sessionInfo()
```

